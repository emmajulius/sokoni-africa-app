{% extends "admin/base.html" %}

{% block page_title %}Fees Management{% endblock %}

{% block content %}
<div class="page-header">
    <h1>Fees Management</h1>
    <div class="header-actions">
        <a href="/admin/fees/cashout" class="btn btn-primary">üí∞ Request Cashout</a>
        <a href="/admin/fees/history" class="btn btn-secondary">üìú Cashout History</a>
    </div>
</div>

<!-- Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">üíµ</div>
        <div class="stat-content">
            <h3>Total Processing Fees</h3>
            <p class="stat-value">{{ "{:,.2f}".format(stats.total_processing_fees) }} SOK</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">üöö</div>
        <div class="stat-content">
            <h3>Total Shipping Fees</h3>
            <p class="stat-value">{{ "{:,.2f}".format(stats.total_shipping_fees) }} SOK</p>
        </div>
    </div>
    
    <div class="stat-card highlight">
        <div class="stat-icon">üí∞</div>
        <div class="stat-content">
            <h3>Total Collected Fees</h3>
            <p class="stat-value">{{ "{:,.2f}".format(stats.total_fees) }} SOK</p>
        </div>
    </div>
    
    <div class="stat-card success">
        <div class="stat-icon">‚úÖ</div>
        <div class="stat-content">
            <h3>Available Balance</h3>
            <p class="stat-value">{{ "{:,.2f}".format(stats.available_balance) }} SOK</p>
            <p class="stat-subtitle">Ready for cashout</p>
        </div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">üí∏</div>
        <div class="stat-content">
            <h3>Total Cashed Out</h3>
            <p class="stat-value">{{ "{:,.2f}".format(stats.total_cashed_out) }} SOK</p>
            <p class="stat-subtitle">Completed cashouts only</p>
        </div>
    </div>
    
    {% if stats.pending_cashouts_amount > 0 %}
    <div class="stat-card warning">
        <div class="stat-icon">‚è≥</div>
        <div class="stat-content">
            <h3>Pending Cashouts</h3>
            <p class="stat-value">{{ "{:,.2f}".format(stats.pending_cashouts_amount) }} SOK</p>
            <p class="stat-subtitle">Reserved ({{ stats.pending_cashouts_count }} request(s))</p>
        </div>
    </div>
    {% endif %}
    
    <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-content">
            <h3>Recent Fees (30 days)</h3>
            <p class="stat-value">{{ "{:,.2f}".format(stats.recent_total) }} SOK</p>
            <p class="stat-subtitle">
                Processing: {{ "{:,.2f}".format(stats.recent_processing) }} SOK<br>
                Shipping: {{ "{:,.2f}".format(stats.recent_shipping) }} SOK
            </p>
        </div>
    </div>
</div>

<!-- Pending Cashouts -->
{% if stats.pending_cashouts_count > 0 %}
<div class="detail-card" style="margin-top: 20px;">
    <h2>‚ö†Ô∏è Pending Cashouts ({{ stats.pending_cashouts_count }})</h2>
    <div class="table-container">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Amount</th>
                    <th>Payout Method</th>
                    <th>Account</th>
                    <th>Requested</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for cashout in stats.pending_cashouts %}
                <tr>
                    <td>#{{ cashout.id }}</td>
                    <td><strong>{{ "{:,.2f}".format(cashout.amount) }} SOK</strong></td>
                    <td>{{ cashout.payout_method }}</td>
                    <td>{{ cashout.payout_account }}</td>
                    <td>{{ cashout.created_at.strftime('%Y-%m-%d %H:%M') if cashout.created_at else '-' }}</td>
                    <td>
                        <a href="/admin/fees/history" class="btn btn-sm btn-info">View</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}

<!-- Info Card -->
<div class="info-card" style="margin-top: 20px;">
    <h3>‚ÑπÔ∏è How Cashouts Work</h3>
    <ul>
        <li><strong>Pending cashouts</strong> reserve the amount but don't deduct from balance yet</li>
        <li><strong>Only COMPLETED cashouts</strong> actually deduct from the available balance (just like the mobile app)</li>
        <li>When you mark a cashout as <strong>Completed</strong>, the amount is permanently deducted</li>
        <li>Available balance = Total fees - Completed cashouts - Pending cashouts</li>
    </ul>
</div>

<!-- Fee Breakdown -->
<div class="detail-card" style="margin-top: 20px;">
    <h2>Fee Breakdown</h2>
    <div class="detail-grid">
        <div class="detail-item">
            <label>Total Orders:</label>
            <span>{{ stats.total_orders }}</span>
        </div>
        <div class="detail-item">
            <label>Average Processing Fee per Order:</label>
            <span>
                {% if stats.total_orders > 0 %}
                {{ "{:,.2f}".format(stats.total_processing_fees / stats.total_orders) }} SOK
                {% else %}
                0.00 SOK
                {% endif %}
            </span>
        </div>
        <div class="detail-item">
            <label>Average Shipping Fee per Order:</label>
            <span>
                {% if stats.total_orders > 0 %}
                {{ "{:,.2f}".format(stats.total_shipping_fees / stats.total_orders) }} SOK
                {% else %}
                0.00 SOK
                {% endif %}
            </span>
        </div>
        <div class="detail-item">
            <label>Cashout Rate:</label>
            <span>
                {% if stats.total_fees > 0 %}
                {{ "{:.1f}".format((stats.total_cashed_out / stats.total_fees) * 100) }}%
                {% else %}
                0%
                {% endif %}
            </span>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 20px;
}

.stat-card {
    background: white;
    border-radius: 8px;
    padding: 24px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 16px;
    transition: transform 0.2s, box-shadow 0.2s;
}

.stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.stat-card.highlight {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
}

.stat-card.success {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
}

.stat-card.warning {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
}

.stat-icon {
    font-size: 2.5em;
    line-height: 1;
}

.stat-content {
    flex: 1;
}

.stat-content h3 {
    margin: 0 0 8px 0;
    font-size: 0.9em;
    font-weight: 600;
    opacity: 0.9;
}

.stat-value {
    margin: 0;
    font-size: 1.8em;
    font-weight: bold;
    line-height: 1.2;
}

.stat-subtitle {
    margin: 8px 0 0 0;
    font-size: 0.85em;
    opacity: 0.8;
}

.detail-card {
    background: white;
    border-radius: 8px;
    padding: 24px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.detail-card h2 {
    margin-top: 0;
    margin-bottom: 20px;
    color: #333;
    font-size: 1.5em;
    border-bottom: 2px solid #f0f0f0;
    padding-bottom: 10px;
}

.detail-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
}

.detail-item {
    display: flex;
    flex-direction: column;
    gap: 4px;
}

.detail-item label {
    font-weight: 600;
    color: #666;
    font-size: 0.9em;
}

.detail-item span {
    color: #333;
    font-size: 1em;
}

.info-card {
    background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
    border: 1px solid #667eea30;
    border-radius: 8px;
    padding: 20px;
}

.info-card h3 {
    margin-top: 0;
    margin-bottom: 12px;
    color: #667eea;
    font-size: 1.2em;
}

.info-card ul {
    margin: 0;
    padding-left: 20px;
    color: #555;
}

.info-card li {
    margin: 8px 0;
    line-height: 1.6;
}
</style>
{% endblock %}

